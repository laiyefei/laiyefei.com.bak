---
layout: detail
title: 文件系统的疑惑 (一) 【Windows篇】
tags: windows
categories: 原理
---

* TOC
{:toc}

# 序言

都说程序员要用mac，我却未必苟同。windows这么傻瓜式，里面的程序肯定牛逼，如果认真去吃，肯定很有营养。	假装鸡汤废话了一下。既然在windows下工作，那么对于这个好朋友你又理解多少呢。笔者带着这个疑惑思考了下，还是想深入了解下文件系统。

# 大纲
大家都拆开机箱看过内部结构吧，我们知道计算机的组成部分最主要的东西莫过于cpu，内存，硬盘了，其中数据存放的地方无非在寄存器，内存，硬盘里面，而其中，只有硬盘是断电，数据还能存在的。因为，数据以磁的形式存在了内部。数据被持久化了，没错，这就是文件，文件就是磁盘中的数据。（至于为什么，自己去读物理吧&lt; _ &lt;，以后想读物理再讨论下。）<br />

## 磁盘

### 物理结构

磁盘，就是硬盘，分SSD和HDD；SSD以后再研究，这里就先研究下HDD吧。HDD就是传统的机械硬盘，先来一张图压压惊。<br />
![机械硬盘完整结构][HDDInfo]<br />
看完了硬盘的整体结构，我们最关心的是硬盘数据的存储，其中最重要的地方包括：磁头数，磁道，柱面，扇区，圆盘。<br />
![机械硬盘的物理结构][HDDPhyInfo]<br />
![机械硬盘的物理结构][diskHDD]
~~~
磁头数：每个盘面一般有上下两面，每个面对应1个磁头，共2个磁头，实现数据的存取。
磁道：当磁盘旋转时，每个磁头就会在盘面划出一个圆形轨迹，这些轨迹叫做磁道。从外到内，从0开始编号，根据磁化的方向，来存取 0 和 1。
柱面：不同盘面的相同编号的磁道构成的圆柱面就被称为柱面，显然，圆柱面与一个盘面的磁道数是相等的。
扇区：每个磁道被分成很多扇形区域，每个扇区的大小为512b，每个磁道的扇区数量相同。
圆盘：就是硬盘的盘面，那个直观看到的金属片。
~~~
**硬盘的容量 = 柱面数 × 磁头数 × 扇区数 × 512（字节数）**

### 逻辑结构
我们先来看看硬盘的整体逻辑划分<br />
![机械硬盘的逻辑分区][HDDLogicInfo]<br />
看着这个蓝图，我们来聊聊其中的逻辑结构：<br />

→ 主引导记录 MBR(Master Boot Record)<br />
![主引导扇区][MBR]<br />
硬盘的0柱面、0磁头、1扇区（为什么从1开始，笔者顶着好奇心搜索的一下，原来是和一种叫做CHS的引导方法有关系，把扇区引导成1扇区，事实上他的逻辑名称还是0扇区。）称为主引导扇区（也叫主引导记录MBR）。它由三个部分组成：硬盘主引导程序(BootLoader)、硬盘分区表DPT（Disk Partition table）和魔数(Magic Number)。
~~~
主引导程序：主引导程序，启动操作系统的一段代码，占446个字节。
硬盘分区表：占64个字节，硬盘中分区有多少以及每一分区的大小都记在其中。
魔术数：占2个字节，固定为0xAA55或0x55AA，这取决于处理器类型，如果是小端模式处理器(如Intel系列)，则该值为0xAA55；如果是大端模式处理器（如Motorola6800），则该值为0x55AA。
~~~

→ 基本分区表 Partition Table
MBR和基本分区表共用硬盘的第一个扇区（即0面0道1扇区，以后简称第一扇区MBR），分区表位于扇区的最后66字节，除了最后的2字节55AA外，为4条分区记录，每条分区记录16字节。<br />
各字段的含义如下：
~~~
  偏移 	|  意义
--------+-----------------...
  0	|  自举标志（80为活动分区，00为非活动分区）
--------+-----------------...
  1	|  起始磁头号H
--------+-----------------...
  2	|  起始扇区号S
--------+-----------------...
  3	|  起始柱面号CYL（CYL的高2位存放在S字节的高2位
--------+-----------------...
  4	|  分区格式标志（01：fat12；05：extended；06：fat16；07：hpfs/ntfs；0b，0d：win95 fat32；0e：win95 fat16；82：Linux swap；83：linux；85：linux extended）
--------+-----------------...
  5	|  终止磁头号H
--------+-----------------...
  6	|  终止扇区号S
--------+-----------------...
  7	|  终止柱面号CYL
--------+-----------------...
  8~11	|  本分区之前已用扇区数（当分区表属于扩展分区中的记录时，该值为相对扩展分区首地址的位置）
--------+-----------------...
  12~15	|  本分区扇区总数
--------------------------...
【注意：C/H/S(柱面/磁道/扇区)的编址从0/0/1开始】
~~~
可以看出，使用C/H/S三维地址时，磁盘的寻址空间最多只有2<sup>24</sup>个扇区，即8GB的容量，当磁盘容量大于8GB时，C/H/S就无法寻址了。<br />
于是采用**LBA**（logic block address）线性地址来寻址。在LBA方式下**系统把所以的物理扇区都按某种方式或规则看做是一线性编号的扇区**，即**从0到某个最大值方式排列**。
~~~
C/H/S到LBA：
	LBA = (C-c) * PH * PS + (H - h) * PS + (S - s)
【注：一般情况下c=0，h=0，s=1，PS=63，PH=255，PS表示每磁道多少扇区，PH表示每柱面多少磁道。】
LBA到C/H/S：
	C = LBA / (PH * PS) + c
 	H = (LBA / PS) MOD PH + h
 	S = LBA MOD PS + s
【注：由于MBR只能记录4个分区的信息，windows通过扩展分区来记录多于4个分区的记录，称做虚拟MBR。】
~~~

## 文件系统

### 定义
先上定义：**所谓文件系统，它是操作系统中藉以组织、存储和命名文件的结构。**磁盘或分区和它所包括的文件系统的不同是很重要的，大部分应用程序都基于文件系统进行操作，在不同种文件系统上是不能工作的。<br />
文件系统就是在硬盘上存储信息的格式。在所有的计算机系统中，都存在一个相应的文件系统，它规定了计算机对文件和文件夹进行操作处理的各种标准和机制。因此，用户对所有的文件和文件夹的操作都是通过文件系统来完成的。

### 划分

### 一些概念
~~~
FAT 【标准文件分配表】：运行Windows NT、Windows 95、MS - DOS或OS/2可以存取主分区或者逻辑分区FAT上的文件。
FAT32 【增强的文件分配表】：这是在大型磁盘驱动器（超过512 兆字节）上存储文件的极有效的系统，如果用户的驱动器使用了这种格式，则会在驱动器上创建多至几百兆的额外硬盘空间，从而更高效地存储数据。此外，可使程序运行加快50 %，而使用的计算机系统资源却更少。
NTFS 【新技术文件系统】：只有运行Windows 2000或Windows NT的计算机才可以存取NTFS卷中的文件。
exFAT【扩展文件分配表】：是Microsoft在Windows Embeded 5.0以上（包括Windows CE 5.0、6.0、Windows Mobile5、6、6.1）中引入的一种适合于闪存的文件系统，为了解决FAT32等不支持4G及其更大的文件而推出。
VFAT【扩展文件分配表系统】：主要应用于在Windows 95中。它对FAT16文件系统进行扩展，并提供支持长文件名，文件名可长达255个字符，VFAT仍保留有扩展名，而且支持文件日期和时间属性，为每个文件保留了文件创建日期/时间、文件最近被修改的日期/时间和文件最近被打开的日期/时间这三个日期/时间。
HPFS【高性能文件系统】：OS/2的高性能文件系统(HPFS)主要克服了FAT文件系统不适合于高档操作系统这一缺点，HPFS支持长文件名，比FAT文件系统有更强的纠错能力。Windows NT也支持HPFS，使得从OS/2到Windows NT的过渡更为容易。HPFS和NTFS有包括长文件名在内的许多相同特性，但使用可靠性较差。
DBR【dos boot record】：操作系统可访问的第一个扇区。包括一个引导程序和BPB（bios parameter block）的本分区参数记录表。
FDT【文件目录表】：只存在FAT12和FAT16中，紧跟在FAT2后。根目录下的文件和子目录在FDT中都有一个‘目录登记项'每个项占32字节，项数在BPB中说明。FAT32中FDT无固定位置，把FDT当作一个普通文件处理，在BPB中指出FDT首簇地址。
~~~

#### 解析FAT

##### 概念

FAT（file allocation table）fat中的记录和磁盘上的簇对应。FAT2为FAT1的备份。FAT的格式有多种，其中FAT16是指文件分配表使用16位表示一个簇，FAT12，FAT32同理。可知FAT16最多能管理65536个簇，而每簇最大32kb，所以FAT16每个分区最大2GB。<br />
→ FAT12，FAT16：<br />
**DBR--FAT1--FAT2--FDT--DATA** <br />
DBR只占1个扇区，FDT为根目录表，根目录下的DIR项数固定，一般为512项，每项占32字节，即DIR占32个扇区。<br />
则一个文件的逻辑扇区号:<br />
~~~
逻辑扇区号 = 1 + 2 * FAT占用的扇区数 + DIR占用的扇区数 + (起始簇号 - 2 ) * 每簇扇区数
~~~
→ FAT32：<br />
**DBR和其后的保留扇区--FAT1--FAT2--DATA** <br />
在DBR使用3个扇区，实际只使用第1个扇区，2，3扇区也写入55AA标志，之后有保留扇区，一般为20h或21h，其中第6扇区是DBR的备份。同时DIR当作文件处理，不在固定位置，也没有固定大小。<br />
则文件的逻辑扇区号：<br />
~~~
逻辑扇区号 = 保留扇区数 + 2 * FAT占用扇区数 + (起始簇号 - 2) * 每簇扇区数
~~~

##### 参数

→ FAT16的BPB：<br />
~~~
  偏移  |  长度 |  说明
-------+-------+-----------...
  00   |   3   |  JMP指令；跳转到引导程序。后随一个空操作。（不属BPB）
-------+-------+-----------...
  03   |   8   |  OEM标志（FAT16为MSWIN4.0）
-------+-------+-----------...
  0B   |   2   |  每扇区字节数
-------+-------+-----------...
  0D   |   1   |  每簇扇区数
-------+-------+-----------...
  0E   |   2   |  dos保留扇区数
-------+-------+-----------...
  10   |   1   |  FAT数
-------+-------+-----------...
  11   |   2   |  根目录项数，如512
-------+-------+-----------...
  13   |   2   |  扇区数（小于32M的分区）
-------+-------+-----------...
  15   |   1   |  介质描述符
-------+-------+-----------...
  16   |   2   |  每FAT扇区数
-------+-------+-----------...
  18   |   2   |  每磁道扇区数（逻辑参数）
-------+-------+-----------...
  1A   |   2   |  磁头数（逻辑参数)
-------+-------+-----------...
  1C   |   4   |  隐含扇区（即分区表中的8-11字节——本分区之前已用扇区数）***
-------+-------+-----------...
  20   |   4   |  扇区数（即分区表中的12-15字节）
-------+-------+-----------...
  24   |   1   |  BIOS设备号（hex：HD=8x）
-------+-------+-----------...
  25   |   1   |  未使用
-------+-------+-----------...
  26   |   1   |  扩展引导标记
-------+-------+-----------...
  27   |   4   |  卷序列号（随机）
-------+-------+-----------...
  2B   |   11  |  卷标，分区标识，如：WIN98
-------+-------+-----------...
  36   |   8   |  文件系统格式：FAT16
-------+-------+-----------...
~~~
→ FAT32的BPB：<br />
~~~
  偏移  |  长度 |  说明
-------+-------+-----------...
  00   |   3   |  JMP指令；跳转到引导程序。后随一个空操作。（不属BPB）
-------+-------+-----------...
  03   |   8   |  OEM标志（FAT32为MSWIN4.1）
-------+-------+-----------...
  0B   |   2   |  每扇区字节数
-------+-------+-----------...
  0D   |   1   |  每簇扇区数
-------+-------+-----------...
  0E   |   2   |  dos保留扇区数，FAT32中一般是32
-------+-------+-----------...
  10   |   1   |  FAT数
-------+-------+-----------...
  11   |   2   |  根目录项数，一般为0，未使用
-------+-------+-----------...
  13   |   2   |  扇区数（小于32M的分区，FAT32中不再使用）
-------+-------+-----------...
  15   |   1   |  介质描述符
-------+-------+-----------...
  16   |   2   |  FAT扇区数（FAT32下不用）
-------+-------+-----------...
  18   |   2   |  每磁道扇区数（逻辑参数）
-------+-------+-----------...
  1A   |   2   |  磁头数（逻辑参数)
-------+-------+-----------...
  1C   |   4   |  隐含扇区（即分区表中的8-11字节——本分区之前已用扇区数）***
-------+-------+-----------...
  20   |   4   |  扇区数（即分区表中的12-15字节）
-------+-------+-----------...
  24   |   4   |  每FAT扇区数
-------+-------+-----------...
  28   |   2   |  标记
-------+-------+-----------...
  2A   |   2   |  版本
-------+-------+-----------...
  2C   |   4   |  根目录首簇地址
-------+-------+-----------...
  30   |   2   |  DBR占用的扇区数
-------+-------+-----------...
  32   |   2   |  备份DBR地址
-------+-------+-----------...
  34   |   12  |  保留
-------+-------+-----------...
  40   |   1   |  BIOS设备号（hex：HD=8x）
-------+-------+-----------...
  41   |   1   |  未使用
-------+-------+-----------...
  42   |   1   |  扩展引导标记
-------+-------+-----------...
  43   |   4   |  卷序列号（随机）
-------+-------+-----------...
  47   |   11  |  卷标，分区标识，如：WIN2000
-------+-------+-----------...
  52   |   8   |  文件系统格式：FAT32
-------+-------+-----------...
~~~
→ 磁介质描述符：
~~~
  十六进制  |  说明
-----------+---------------...
    F8     |  硬盘
-----------+---------------...
    F9     |  双面5in软盘（15扇区高密度）双面3in软盘
-----------+---------------...
    FA     |  双面3in RAM虚拟盘
-----------+---------------...
    FC     |  单面5in软盘（9扇区高密度） 双面8in盘
-----------+---------------...
    FD     |  双面5in盘（9扇区低密度）
-----------+---------------...
    FE     |  单面8in盘（单、双密度）单面5in盘（8扇区低密度）
-----------+---------------...
    FF     |  双面5in盘（8扇区低密）
-----------+---------------...
~~~
→ FAT中每个簇号可取的表项值及含义：
~~~
 表项值（12位）	|	 表项值（16位）	 |  	表项值（32位）	 | 	 簇描述含义
----------------+------------------------+-----------------------+-------------------------...
     000H       |        0000H           |       00000000H       |  未使用的簇
----------------+------------------------+-----------------------+-------------------------...
     002H-FEFH  |       0002H-FFEFH      |  00000002H-FFFFFFEFH  |  已分配的簇（可见簇号从2开始）
----------------+------------------------+-----------------------+-------------------------...
     FF0H-FF6H  |       FFF0H-FFF6H      |  FFFFFFF0H-FFFFFFF6H  |  保留
----------------+------------------------+-----------------------+-------------------------...
     FF7H       |        FFF7H           |       FFFFFFF7H       |  坏簇
----------------+------------------------+-----------------------+-------------------------...
     FF8H-FFFH  |       FFF8H-FFFFH      |  FFFFFFF8H-FFFFFFFFH  |  文件结束簇
----------------+------------------------+-----------------------+-------------------------...
~~~
→ FAT16的FDT字段含义：
~~~
  偏移  |  长度 |  说明
--------+------+-----------...
  0-7   |   8  |  文件名
--------+------+-----------...
  8-10  |   3  |  扩展名
--------+------+-----------...
  11    |   1  |  属性字节（00000000读写，00000001只读，00000010隐藏，00000100系统，00001000卷标，00010000子目录，00100000档案）
--------+------+-----------...
  12-21 |  10  |  保留未用
--------+------+-----------...
  22-23 |  2   |  文件创建时间（hhhhh mmmmmm sssss）
--------+------+-----------...
  24-25 |  2   |  文件创建时间（yyyyyyy mmmm ddddd）
--------+------+-----------...
  26-27 |  2   |  表示文件的首簇号
--------+------+-----------...
  28-31 |  4   |  文件长度
--------+------+-----------...
~~~

→ FAT32的FDT字段含义：
~~~
  偏移  |  长度 |  说明
--------+------+-----------...
  0-7   |   8  |  文件名
--------+------+-----------...
  8-10  |   3  |  扩展名
--------+------+-----------...
  11    |   1  | 属性字节（同FAT16，但为0FH时，表示该项为长文件名记录项）
--------+------+-----------...
  12-13 |   2  |  种类、校验和
--------+------+-----------...
  13-15 |   3  |  文件创建时间（hhhhh mmmmmm sssss，后8位为毫秒数）
--------+------+-----------...
  16-17 |   2  |  文件创建时间（yyyyyyy mmmm ddddd）
--------+------+-----------...
  18-19 |   2  |  最新访问日期，定义同16-17
--------+------+-----------...
  20-21 |   2  |  起始簇的高16位
--------+------+-----------...
  22-23 |   2  |  最新修改时间（hhhhh mmmmmm sssss）
--------+------+-----------...
  24-25 |   2  |  最新修改日期，定义同16-17
--------+------+-----------...
  26-27 |   2  |  起始簇的低16位
--------+------+-----------...
  28-31 |   4  |  文件长度
--------+------+-----------...
~~~
通过以上信息，即可读出FAT系统中任意文件的内容。<br />
笔者这里只借助FAT说明，深入理解文件系统。<br />
精力有限，笔者就先折腾到这里，以后有空再继续折腾。读者可自行搜索。<br />




**（以上，仅代表个人观点。无论对错，欢迎交流。^_^ ）**

[HDDInfo]: {{ "/2017-07-12-HDD.png" | prepend: site.imgrepo }}
[HDDPhyInfo]: {{ "/2017-07-12-HDDPhyInfo.png" | prepend: site.imgrepo }}
[diskHDD]: {{ "/2017-07-12-diskHDD.png" | prepend: site.imgrepo }}
[HDDLogicInfo]: {{ "/2017-07-12-logicHDD.png" | prepend: site.imgrepo }}
[MBR]: {{ "/2017-07-12-mbr.png" | prepend: site.imgrepo }}
